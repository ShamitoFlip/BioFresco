<!-- Formulario para Producto de Proveedor (Editar) -->
<div class="form-header mb-3">
    <h5 class="mb-0">
        <i class="fas fa-truck text-info me-2"></i>Editar Producto de Proveedor
    </h5>
</div>

<div class="row g-3">
    <!-- Nombre de Proveedor -->
    <div class="col-12">
        <label for="id_proveedor_seleccionado_edit" class="form-label">
            Nombre de Proveedor <span class="text-danger">*</span>
        </label>
        <select class="form-control" 
                id="id_proveedor_seleccionado_edit" 
                name="proveedor_seleccionado"
                required
                data-required="true">
            <option value="">-- Seleccione un proveedor --</option>
            {% for proveedor in proveedores %}
                <option value="{{ proveedor.id }}" {% if producto.producto_proveedor and producto.producto_proveedor.proveedor.id == proveedor.id %}selected{% endif %}>
                    {{ proveedor.nombre }}
                </option>
            {% endfor %}
        </select>
        <small class="form-text text-muted">Seleccione un proveedor para ver sus productos</small>
    </div>

    <!-- Nombre de Producto -->
    <div class="col-12">
        <label for="id_producto_proveedor_edit" class="form-label">
            Nombre de Producto <span class="text-danger">*</span>
        </label>
        <select class="form-control" 
                id="id_producto_proveedor_edit" 
                name="producto_proveedor"
                {% if not producto.producto_proveedor %}disabled{% endif %}
                required
                data-required="true">
            <option value="">{% if producto.producto_proveedor %}Seleccione un proveedor primero{% else %}Cargando...{% endif %}</option>
            {% if producto.producto_proveedor %}
                <option value="{{ producto.producto_proveedor.id }}" selected>
                    {{ producto.producto_proveedor.nombre }}
                </option>
            {% endif %}
        </select>
        <small class="form-text text-muted">Seleccione un producto del proveedor seleccionado</small>
    </div>

    <!-- Categor√≠a -->
    <div class="col-md-6">
        <label for="id_categoria_proveedor_edit" class="form-label">
            <i class="fas fa-layer-group me-2"></i>Categor√≠a
        </label>
        <select class="form-control" 
                id="id_categoria_proveedor_edit" 
                name="categoria">
            <option value="">-- Seleccione una categor√≠a --</option>
            <option value="frutas" {% if producto.categoria == 'frutas' %}selected{% endif %}>Frutas</option>
            <option value="verduras" {% if producto.categoria == 'verduras' %}selected{% endif %}>Verduras</option>
            <option value="frutos_secos" {% if producto.categoria == 'frutos_secos' %}selected{% endif %}>Frutos Secos</option>
            <option value="preelaborados" {% if producto.categoria == 'preelaborados' %}selected{% endif %}>Preelaborados</option>
        </select>
        <small class="form-text text-muted">Categor√≠a del producto</small>
    </div>

    <!-- Stock M√≠nimo -->
    <div class="col-md-6">
        <label for="id_stock_minimo_proveedor_edit" class="form-label">
            Stock M√≠nimo <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_stock_minimo_proveedor_edit" 
               name="stock_minimo" 
               value="{{ producto.stock_minimo }}"
               min="0"
               required
               data-required="true">
    </div>

    <!-- Cantidad de Stock Disponible -->
    <div class="col-md-6">
        <label for="id_cantidad_proveedor_edit" class="form-label">
            Cantidad Existente <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_cantidad_proveedor_edit" 
               name="cantidad" 
               value="{{ producto.cantidad }}"
               min="0"
               readonly
               required
               data-required="true"
               data-auto-calculated="true">
        <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Esta cantidad se calcula autom√°ticamente desde las entradas de inventario
        </small>
    </div>

    <!-- Precio Venta -->
    <div class="col-md-6">
        <label for="id_precio_proveedor_edit" class="form-label">
            Precio Venta <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_precio_proveedor_edit" 
               name="precio" 
               value="{{ producto.precio|default:0 }}"
               min="0"
               step="1"
               required
               data-required="true">
    </div>

    <!-- Precio Costo -->
    <div class="col-md-6">
        <label for="id_costo_promedio_actual_proveedor_edit" class="form-label">
            Precio Costo <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_costo_promedio_actual_proveedor_edit" 
               name="costo_promedio_actual" 
               value="{{ producto.costo_promedio_actual|default:0 }}"
               min="0"
               step="0.01"
               readonly
               style="background-color: #e9ecef;">
        <small class="form-text text-muted">Se completar√° autom√°ticamente desde el producto de proveedor</small>
    </div>

    <!-- Unidad de Medida -->
    <div class="col-md-6">
        <label for="id_unidad_medida_proveedor_edit" class="form-label">
            Unidad de Medida
        </label>
        <input type="text" 
               class="form-control" 
               id="id_unidad_medida_proveedor_edit" 
               name="unidad_medida" 
               value="{{ producto.unidad_medida|default:'' }}"
               placeholder="Ej: kg, unidades, cajas">
        <small class="form-text text-muted">Se completar√° autom√°ticamente desde el producto de proveedor</small>
    </div>

    <!-- Zona -->
    <div class="col-md-6">
        <label for="id_zona_select_proveedor_edit" class="form-label">
            Zona
        </label>
        <div class="input-group">
            <select class="form-control" 
                    id="id_zona_select_proveedor_edit" 
                    name="zona">
                <option value="">-- Seleccione una zona --</option>
                {% for zona in zonas %}
                    <option value="{{ zona.id }}" {% if producto.zona and producto.zona.id == zona.id %}selected{% endif %}>
                        {{ zona.nombre }}
                    </option>
                {% endfor %}
            </select>
            <button type="button" 
                    class="btn btn-outline-primary" 
                    id="btn-crear-zona-proveedor-edit"
                    title="Crear nueva zona">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <small class="form-text text-muted">Zona o ubicaci√≥n donde se almacena el producto</small>
    </div>

    <!-- Descripci√≥n -->
    <div class="col-12">
        <label for="id_descripcion_proveedor_edit" class="form-label">
            Descripci√≥n
        </label>
        <textarea class="form-control" 
                  id="id_descripcion_proveedor_edit" 
                  name="descripcion" 
                  rows="4"
                  placeholder="Descripci√≥n del producto">{{ producto.descripcion|default:'' }}</textarea>
        <small class="form-text text-muted">Se completar√° autom√°ticamente desde el producto de proveedor</small>
    </div>

    <!-- Imagen del Producto -->
    <div class="col-12">
        <label for="id_imagen_proveedor_edit" class="form-label">
            Imagen del Producto
        </label>
        {% if producto.imagen %}
            <div class="mb-2">
                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" style="max-width: 200px; max-height: 200px;" class="img-thumbnail">
                <p class="text-muted small mt-1">Imagen actual</p>
            </div>
        {% endif %}
        <input type="file" 
               class="form-control" 
               id="id_imagen_proveedor_edit" 
               name="imagen" 
               accept="image/*">
        <small class="form-text text-muted">Deje en blanco para mantener la imagen actual</small>
    </div>

    <!-- Activo -->
    <div class="col-12">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="id_activo_proveedor_edit" name="activo" {% if producto.activo %}checked{% endif %}>
            <label class="form-check-label" for="id_activo_proveedor_edit">
                Producto Activo
            </label>
        </div>
    </div>
    
    <!-- Campo oculto para nombre (se completar√° autom√°ticamente desde producto_proveedor) -->
    <input type="hidden" id="id_nombre_producto_proveedor_edit" name="nombre" value="{{ producto.nombre }}">
</div>

<script>
(function() {
    'use strict';
    
    function inicializarModalCrearZonaProveedorEdit() {
        const btnCrearZona = document.getElementById('btn-crear-zona-proveedor-edit');
        const selectZona = document.getElementById('id_zona_select_proveedor_edit');
        
        if (!btnCrearZona) {
            return false;
        }
        
        const nuevoBtn = btnCrearZona.cloneNode(true);
        btnCrearZona.parentNode.replaceChild(nuevoBtn, btnCrearZona);
        
        const btnActual = document.getElementById('btn-crear-zona-proveedor-edit');
        
        btnActual.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            let modalEl = document.getElementById('modalCrearZonaProveedorEdit');
            
            if (!modalEl) {
                modalEl = document.createElement('div');
                modalEl.id = 'modalCrearZonaProveedorEdit';
                modalEl.className = 'modal fade';
                modalEl.setAttribute('tabindex', '-1');
                modalEl.setAttribute('aria-labelledby', 'modalCrearZonaProveedorEditLabel');
                modalEl.setAttribute('aria-hidden', 'true');
                modalEl.style.zIndex = '9999';
                
                modalEl.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered" style="z-index: 10000;">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white;">
                                <h5 class="modal-title" id="modalCrearZonaProveedorEditLabel">
                                    <i class="fas fa-map-marker-alt me-2"></i>Crear Nueva Zona
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="form-crear-zona-proveedor-edit">
                                    <div class="mb-3">
                                        <label for="nombre_zona_nueva_proveedor_edit" class="form-label">Nombre de la Zona *</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="nombre_zona_nueva_proveedor_edit" 
                                               name="nombre" 
                                               placeholder="Ej: Almac√©n A, Estanter√≠a 3, Zona Fr√≠a"
                                               required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="descripcion_zona_nueva_proveedor_edit" class="form-label">Descripci√≥n (Opcional)</label>
                                        <textarea class="form-control" 
                                                  id="descripcion_zona_nueva_proveedor_edit" 
                                                  name="descripcion" 
                                                  rows="3"
                                                  placeholder="Descripci√≥n de la zona"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-success" id="btn-guardar-zona-proveedor-edit">
                                    <i class="fas fa-save me-2"></i>Guardar Zona
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalEl);
            }
            
            const modalOptions = {
                backdrop: true,
                keyboard: true,
                focus: true
            };
            
            const bsModal = new bootstrap.Modal(modalEl, modalOptions);
            
            const btnGuardarZona = document.getElementById('btn-guardar-zona-proveedor-edit');
            if (btnGuardarZona) {
                const nuevoBtnGuardar = btnGuardarZona.cloneNode(true);
                btnGuardarZona.parentNode.replaceChild(nuevoBtnGuardar, btnGuardarZona);
                
                const btnGuardarActual = document.getElementById('btn-guardar-zona-proveedor-edit');
                
                btnGuardarActual.addEventListener('click', function() {
                    const nombre = document.getElementById('nombre_zona_nueva_proveedor_edit').value.trim();
                    
                    if (!nombre) {
                        if (typeof showAlertModal === 'function') {
                            showAlertModal('El nombre de la zona es obligatorio', 'error');
                        } else {
                            alert('El nombre de la zona es obligatorio');
                        }
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('nombre', nombre);
                    formData.append('descripcion', document.getElementById('descripcion_zona_nueva_proveedor_edit').value.trim());
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) {
                        formData.append('csrfmiddlewaretoken', csrfToken.value);
                    }
                    
                    btnGuardarActual.disabled = true;
                    btnGuardarActual.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                    
                    fetch('{% url "zona_crear_ajax" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (selectZona) {
                                const option = document.createElement('option');
                                option.value = data.zona.id;
                                option.textContent = data.zona.nombre;
                                option.selected = true;
                                selectZona.appendChild(option);
                            }
                            
                            bsModal.hide();
                            document.getElementById('form-crear-zona-proveedor-edit').reset();
                            
                            if (typeof showAlertModal === 'function') {
                                showAlertModal(data.message, 'success');
                            } else {
                                alert(data.message);
                            }
                        } else {
                            if (typeof showAlertModal === 'function') {
                                showAlertModal(data.error || 'Error al crear la zona', 'error');
                            } else {
                                alert(data.error || 'Error al crear la zona');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (typeof showAlertModal === 'function') {
                            showAlertModal('Error al crear la zona. Por favor, intenta nuevamente.', 'error');
                        } else {
                            alert('Error al crear la zona. Por favor, intenta nuevamente.');
                        }
                    })
                    .finally(() => {
                        btnGuardarActual.disabled = false;
                        btnGuardarActual.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Zona';
                    });
                });
            }
            
            bsModal.show();
            
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop:last-of-type');
                if (backdrop) {
                    backdrop.style.zIndex = '9998';
                }
                if (modalEl) {
                    modalEl.style.zIndex = '9999';
                }
            }, 100);
        });
        
        return true;
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarModalCrearZonaProveedorEdit);
    } else {
        inicializarModalCrearZonaProveedorEdit();
    }
    
    setTimeout(inicializarModalCrearZonaProveedorEdit, 500);
})();
</script>

<script>
(function() {
    'use strict';
    
    console.log('‚úÖ Script de editar_proveedor_fragment.html cargado');
    
    // Funci√≥n para inicializar el script de proveedor (versi√≥n edit)
    function inicializarScriptProveedorEdit() {
        console.log('üîÑ inicializarScriptProveedorEdit ejecutado');
        const proveedorSelect = document.getElementById('id_proveedor_seleccionado_edit');
        const productoSelect = document.getElementById('id_producto_proveedor_edit');
        const costoInput = document.getElementById('id_costo_promedio_actual_proveedor_edit');
        const descripcionTextarea = document.getElementById('id_descripcion_proveedor_edit');
        
        if (!proveedorSelect || !productoSelect) {
            console.log('‚è≥ Esperando elementos del formulario de proveedor edit...', {
                proveedorSelect: !!proveedorSelect,
                productoSelect: !!productoSelect
            });
            return false;
        }
        
        console.log('‚úÖ Elementos encontrados, configurando listeners...');
        
        // Remover listeners anteriores si existen (clonando el elemento)
        const nuevoProveedorSelect = proveedorSelect.cloneNode(true);
        proveedorSelect.parentNode.replaceChild(nuevoProveedorSelect, proveedorSelect);
        
        // Obtener referencia actualizada
        const proveedorSelectActual = document.getElementById('id_proveedor_seleccionado_edit');
        const productoSelectActual = document.getElementById('id_producto_proveedor_edit');
        const costoInputActual = document.getElementById('id_costo_promedio_actual_proveedor_edit');
        const descripcionTextareaActual = document.getElementById('id_descripcion_proveedor_edit');
        
        if (!proveedorSelectActual || !productoSelectActual) {
            console.error('‚ùå No se pudieron obtener las referencias actualizadas');
            return false;
        }
        
        // Cargar productos cuando se selecciona un proveedor
        console.log('‚úÖ Configurando listener para cambio de proveedor...');
        proveedorSelectActual.addEventListener('change', function() {
            const proveedorId = this.value;
            console.log('üîÑ Cambio detectado en proveedor. ID:', proveedorId);
            
            if (!proveedorId) {
                productoSelectActual.innerHTML = '<option value="">Seleccione un proveedor primero</option>';
                productoSelectActual.disabled = true;
                if (costoInputActual) costoInputActual.value = '0.00';
                if (descripcionTextareaActual) descripcionTextareaActual.value = '';
                return;
            }
            
            // Mostrar loading
            productoSelectActual.disabled = true;
            productoSelectActual.innerHTML = '<option value="">Cargando productos...</option>';
            
            // Construir URL
            const url = `{% url "inventario_productos_proveedor_ajax" %}?proveedor_id=${encodeURIComponent(proveedorId)}`;
            console.log('üì° Haciendo petici√≥n AJAX a:', url);
            
            // Hacer petici√≥n AJAX
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log('üì• Respuesta recibida. Status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üì¶ Datos recibidos:', data);
                
                if (data.error) {
                    console.error('‚ùå Error en respuesta:', data.error);
                    productoSelectActual.innerHTML = '<option value="">Error al cargar productos</option>';
                    alert('Error al cargar productos: ' + data.error);
                    return;
                }
                
                productoSelectActual.innerHTML = '<option value="">-- Seleccione un producto --</option>';
                
                // Producto actual seleccionado
                const productoActualId = '{{ producto.producto_proveedor.id|default:"" }}';
                
                if (data.productos && data.productos.length > 0) {
                    console.log(`‚úÖ Cargando ${data.productos.length} productos en el dropdown`);
                    data.productos.forEach((producto, index) => {
                        const option = document.createElement('option');
                        option.value = producto.id;
                        option.textContent = producto.nombre;
                        option.dataset.precio = producto.precio_compra_actual || producto.precio_unitario || '0';
                        option.dataset.descripcion = producto.descripcion || '';
                        option.dataset.nombre = producto.nombre;
                        option.dataset.cantidad = producto.cantidad || '0';
                        
                        // Seleccionar el producto actual si existe
                        if (productoActualId && producto.id.toString() === productoActualId.toString()) {
                            option.selected = true;
                        }
                        
                        productoSelectActual.appendChild(option);
                        console.log(`  ‚úì Producto ${index + 1}: ${producto.nombre} (ID: ${producto.id})`);
                    });
                    productoSelectActual.disabled = false;
                    
                    // Si hay un producto seleccionado, llenar los campos
                    if (productoActualId) {
                        const selectedOption = productoSelectActual.querySelector(`option[value="${productoActualId}"]`);
                        if (selectedOption) {
                            productoSelectActual.dispatchEvent(new Event('change'));
                        }
                    }
                    
                    console.log('‚úÖ Productos cargados exitosamente');
                } else {
                    console.warn('‚ö†Ô∏è No hay productos disponibles para este proveedor');
                    productoSelectActual.innerHTML = '<option value="">No hay productos disponibles</option>';
                    productoSelectActual.disabled = true;
                }
            })
            .catch(error => {
                console.error('‚ùå Error al cargar productos:', error);
                productoSelectActual.innerHTML = '<option value="">Error al cargar productos</option>';
                productoSelectActual.disabled = true;
                alert('Error al cargar los productos del proveedor. Por favor, verifica la consola para m√°s detalles.');
            });
        });
        
        // Llenar datos cuando se selecciona un producto
        if (productoSelectActual.hasAttribute('data-listener-attached-edit')) {
            console.log('‚ö†Ô∏è Listener de producto ya est√° adjunto, omitiendo...');
        } else {
            productoSelectActual.setAttribute('data-listener-attached-edit', 'true');
            
            productoSelectActual.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                console.log('üîÑ Producto seleccionado:', selectedOption.value, selectedOption.textContent);
                
                if (!selectedOption.value) {
                    if (costoInputActual) costoInputActual.value = '0.00';
                    if (descripcionTextareaActual) descripcionTextareaActual.value = '';
                    return;
                }
                
                // Llenar nombre del producto (campo oculto)
                const nombreProducto = selectedOption.dataset.nombre || selectedOption.textContent;
                const nombreInput = document.getElementById('id_nombre_producto_proveedor_edit');
                if (nombreInput) {
                    nombreInput.value = nombreProducto;
                    console.log('üìù Nombre del producto actualizado:', nombreProducto);
                }
                
                // Llenar precio costo
                const precio = selectedOption.dataset.precio || '0';
                if (costoInputActual) {
                    costoInputActual.value = parseFloat(precio).toFixed(2);
                    console.log('üí∞ Precio costo actualizado:', costoInputActual.value);
                }
                
                // Llenar descripci√≥n (pero permite edici√≥n)
                const descripcion = selectedOption.dataset.descripcion || '';
                if (descripcionTextareaActual) {
                    descripcionTextareaActual.value = descripcion;
                    console.log('üìù Descripci√≥n actualizada');
                }
            });
        }
        
        // Si ya hay un proveedor seleccionado, cargar sus productos autom√°ticamente
        if (proveedorSelectActual.value) {
            console.log('‚úÖ Proveedor ya seleccionado, cargando productos autom√°ticamente...');
            proveedorSelectActual.dispatchEvent(new Event('change'));
        }
        
        console.log('‚úÖ Listeners configurados correctamente');
        return true;
    }
    
    // Hacer la funci√≥n disponible globalmente
    window.inicializarScriptProveedorEdit = inicializarScriptProveedorEdit;
    
    console.log('‚úÖ Script de editar_proveedor_fragment.html configurado completamente');
    console.log('‚úÖ inicializarScriptProveedorEdit disponible globalmente:', typeof window.inicializarScriptProveedorEdit);
    
    // Intentar inicializar inmediatamente si el formulario est√° visible
    setTimeout(function() {
        const formularioProveedor = document.getElementById('formulario-proveedor-edit');
        if (formularioProveedor) {
            const style = window.getComputedStyle(formularioProveedor);
            if (style.display !== 'none' && style.visibility !== 'hidden') {
                console.log('‚úÖ Formulario proveedor edit es visible, inicializando autom√°ticamente...');
                inicializarScriptProveedorEdit();
            }
        }
    }, 500);
    
    // Tambi√©n escuchar cuando el formulario se muestre
    document.addEventListener('formularioCambiado', function() {
        console.log('‚úÖ Evento formularioCambiado disparado para edit');
        setTimeout(function() {
            inicializarScriptProveedorEdit();
        }, 100);
    });
})();
</script>


<!-- Formulario para Producto Propio -->
<div class="form-header mb-3">
    <h5 class="mb-0">
        <i class="fas fa-box text-success me-2"></i>Agregar Producto Propio
    </h5>
</div>

<div class="row g-3">
    <!-- Nombre del Producto -->
    <div class="col-12">
        <label for="id_nombre" class="form-label">
            Nombre del Producto <span class="text-danger">*</span>
        </label>
        <input type="text" 
               class="form-control" 
               id="id_nombre" 
               name="nombre" 
               placeholder="Ingrese el nombre del producto"
               required
               data-required="true">
        <small class="form-text text-muted">Ingrese el nombre del producto manualmente</small>
    </div>

    <!-- Categoría -->
    <div class="col-md-6">
        <label for="id_categoria" class="form-label">
            <i class="fas fa-layer-group me-2"></i>Categoría
        </label>
        <select class="form-control" 
                id="id_categoria" 
                name="categoria">
            <option value="">-- Seleccione una categoría --</option>
            <option value="frutas">Frutas</option>
            <option value="verduras">Verduras</option>
            <option value="frutos_secos">Frutos Secos</option>
            <option value="preelaborados">Preelaborados</option>
        </select>
        <small class="form-text text-muted">Categoría del producto</small>
    </div>

    <!-- Stock Mínimo -->
    <div class="col-md-6">
        <label for="id_stock_minimo" class="form-label">
            Stock Mínimo <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_stock_minimo" 
               name="stock_minimo" 
               value="10"
               min="0"
               required
               data-required="true">
        <small class="form-text text-muted">Ayuda a personalizar el stock de alerta del producto</small>
    </div>

    <!-- Cantidad Existente -->
    <div class="col-md-6">
        <label for="id_cantidad" class="form-label">
            Cantidad Existente <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_cantidad" 
               name="cantidad" 
               value="0"
               min="0"
               required
               data-required="true">
    </div>

    <!-- Precio Venta -->
    <div class="col-md-6">
        <label for="id_precio" class="form-label">
            Precio Venta <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_precio" 
               name="precio" 
               value="0"
               min="0"
               step="1"
               required
               data-required="true">
    </div>

    <!-- Precio de Producción / Coste -->
    <div class="col-md-6">
        <label for="id_costo_promedio_actual" class="form-label">
            Precio de Producción / Coste <span class="text-danger">*</span>
        </label>
        <input type="number" 
               class="form-control" 
               id="id_costo_promedio_actual" 
               name="costo_promedio_actual" 
               value="0.00"
               min="0"
               step="0.01"
               required
               data-required="true">
    </div>

    <!-- Unidad de Medida -->
    <div class="col-md-6">
        <label for="id_unidad_medida" class="form-label">
            Unidad de Medida
        </label>
        <input type="text" 
               class="form-control" 
               id="id_unidad_medida" 
               name="unidad_medida" 
               placeholder="Ej: kg, unidades, cajas">
        <small class="form-text text-muted">Unidad de medida del producto</small>
    </div>

    <!-- Zona -->
    <div class="col-md-6">
        <label for="id_zona_select" class="form-label">
            Zona
        </label>
        <div class="input-group">
            <select class="form-control" 
                    id="id_zona_select" 
                    name="zona">
                <option value="">-- Seleccione una zona --</option>
                {% for zona in zonas %}
                    <option value="{{ zona.id }}">{{ zona.nombre }}</option>
                {% endfor %}
            </select>
            <button type="button" 
                    class="btn btn-outline-primary" 
                    id="btn-crear-zona"
                    title="Crear nueva zona">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <small class="form-text text-muted">Zona o ubicación donde se almacena el producto</small>
    </div>

    <!-- Descripción -->
    <div class="col-12">
        <label for="id_descripcion" class="form-label">
            Descripción del Producto
        </label>
        <textarea class="form-control" 
                  id="id_descripcion" 
                  name="descripcion" 
                  rows="4"
                  placeholder="Ingrese una descripción del producto"></textarea>
    </div>

    <!-- Imagen del Producto -->
    <div class="col-12">
        <label for="id_imagen" class="form-label">
            Imagen del Producto
        </label>
        <input type="file" 
               class="form-control" 
               id="id_imagen" 
               name="imagen" 
               accept="image/*">
        <small class="form-text text-muted">Seleccione la imagen del producto</small>
    </div>
</div>

<!-- Campo oculto para activo -->
<input type="hidden" name="activo" value="true">

<!-- Modal para crear zona - Movido fuera del drawer para evitar conflictos de z-index -->
<style>
#modalCrearZona {
    z-index: 9999 !important;
}
#modalCrearZona .modal-backdrop {
    z-index: 9998 !important;
}
</style>

<script>
(function() {
    'use strict';
    
    // Función para inicializar el modal de crear zona
    function inicializarModalCrearZona() {
        const btnCrearZona = document.getElementById('btn-crear-zona');
        const selectZona = document.getElementById('id_zona_select');
        
        if (!btnCrearZona) {
            console.log('⏳ Botón crear zona no encontrado aún...');
            return false;
        }
        
        // Remover listener anterior si existe
        const nuevoBtn = btnCrearZona.cloneNode(true);
        btnCrearZona.parentNode.replaceChild(nuevoBtn, btnCrearZona);
        
        const btnActual = document.getElementById('btn-crear-zona');
        
        btnActual.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('✅ Botón crear zona clickeado');
            
            // Crear modal dinámicamente en el body para evitar conflictos de z-index
            let modalEl = document.getElementById('modalCrearZona');
            
            if (!modalEl) {
                // Crear el modal si no existe
                modalEl = document.createElement('div');
                modalEl.id = 'modalCrearZona';
                modalEl.className = 'modal fade';
                modalEl.setAttribute('tabindex', '-1');
                modalEl.setAttribute('aria-labelledby', 'modalCrearZonaLabel');
                modalEl.setAttribute('aria-hidden', 'true');
                modalEl.style.zIndex = '9999';
                
                modalEl.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered" style="z-index: 10000;">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white;">
                                <h5 class="modal-title" id="modalCrearZonaLabel">
                                    <i class="fas fa-map-marker-alt me-2"></i>Crear Nueva Zona
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="form-crear-zona">
                                    <div class="mb-3">
                                        <label for="nombre_zona_nueva" class="form-label">Nombre de la Zona *</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="nombre_zona_nueva" 
                                               name="nombre" 
                                               placeholder="Ej: Almacén A, Estantería 3, Zona Fría"
                                               required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="descripcion_zona_nueva" class="form-label">Descripción (Opcional)</label>
                                        <textarea class="form-control" 
                                                  id="descripcion_zona_nueva" 
                                                  name="descripcion" 
                                                  rows="3"
                                                  placeholder="Descripción de la zona"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-success" id="btn-guardar-zona">
                                    <i class="fas fa-save me-2"></i>Guardar Zona
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalEl);
            }
            
            // Configurar el modal con opciones para evitar conflictos
            const modalOptions = {
                backdrop: true,
                keyboard: true,
                focus: true
            };
            
            const bsModal = new bootstrap.Modal(modalEl, modalOptions);
            
            // Configurar el botón guardar
            const btnGuardarZona = document.getElementById('btn-guardar-zona');
            if (btnGuardarZona) {
                // Remover listeners anteriores
                const nuevoBtnGuardar = btnGuardarZona.cloneNode(true);
                btnGuardarZona.parentNode.replaceChild(nuevoBtnGuardar, btnGuardarZona);
                
                const btnGuardarActual = document.getElementById('btn-guardar-zona');
                
                btnGuardarActual.addEventListener('click', function() {
                    const nombre = document.getElementById('nombre_zona_nueva').value.trim();
                    
                    if (!nombre) {
                        if (typeof showAlertModal === 'function') {
                            showAlertModal('El nombre de la zona es obligatorio', 'error');
                        } else {
                            alert('El nombre de la zona es obligatorio');
                        }
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('nombre', nombre);
                    formData.append('descripcion', document.getElementById('descripcion_zona_nueva').value.trim());
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) {
                        formData.append('csrfmiddlewaretoken', csrfToken.value);
                    }
                    
                    btnGuardarActual.disabled = true;
                    btnGuardarActual.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                    
                    fetch('{% url "zona_crear_ajax" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Agregar la nueva zona al select
                            if (selectZona) {
                                const option = document.createElement('option');
                                option.value = data.zona.id;
                                option.textContent = data.zona.nombre;
                                option.selected = true;
                                selectZona.appendChild(option);
                            }
                            
                            // Cerrar modal y limpiar formulario
                            bsModal.hide();
                            document.getElementById('form-crear-zona').reset();
                            
                            if (typeof showAlertModal === 'function') {
                                showAlertModal(data.message, 'success');
                            } else {
                                alert(data.message);
                            }
                        } else {
                            if (typeof showAlertModal === 'function') {
                                showAlertModal(data.error || 'Error al crear la zona', 'error');
                            } else {
                                alert(data.error || 'Error al crear la zona');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (typeof showAlertModal === 'function') {
                            showAlertModal('Error al crear la zona. Por favor, intenta nuevamente.', 'error');
                        } else {
                            alert('Error al crear la zona. Por favor, intenta nuevamente.');
                        }
                    })
                    .finally(() => {
                        btnGuardarActual.disabled = false;
                        btnGuardarActual.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Zona';
                    });
                });
            }
            
            // Mostrar el modal
            bsModal.show();
            
            // Asegurar que el modal esté en el top del z-index
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop:last-of-type');
                if (backdrop) {
                    backdrop.style.zIndex = '9998';
                }
                if (modalEl) {
                    modalEl.style.zIndex = '9999';
                }
            }, 100);
        });
        
        console.log('✅ Modal crear zona inicializado');
        return true;
    }
    
    // Intentar inicializar inmediatamente
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarModalCrearZona);
    } else {
        inicializarModalCrearZona();
    }
    
    // También intentar después de un pequeño delay para asegurar que el DOM esté listo
    setTimeout(inicializarModalCrearZona, 500);
})();
</script>

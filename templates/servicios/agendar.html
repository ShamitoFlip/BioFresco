{% extends "base.html" %}

{% block titulo %}Agendar Cita{% endblock %}

{% block contenido %}
<div class="container py-5">
            <div class="card shadow">
                <div class="card-body p-4">
                    <form method="POST" novalidate>
                        {% csrf_token %}
                        {% if admin_mode %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="empleado" class="form-label">Especialista *</label>
                                <select class="form-select" id="empleado_admin" name="empleado" required>
                                    <option value="">Seleccionar especialista</option>
                                    {% for e in empleados %}
                                    <option value="{{ e.id }}" data-especialidades="{% for esp in e.especialidades.all %}{{ esp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ e.nombre }}{% if e.apellido %} {{ e.apellido }}{% endif %}{% if e.especialidades.all %} - {% for esp in e.especialidades.all|slice:":3" %}{{ esp.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}{% elif e.cargo %} - {{ e.cargo }}{% elif e.especialidad %} - {{ e.especialidad }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted d-block mt-1" id="empleado-admin-ayuda">
                                    Selecciona un servicio primero para ver los empleados disponibles
                                </small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="servicio" class="form-label">Servicio *</label>
                                <select class="form-select" id="servicio" name="servicio" required>
                                    <option value="">Seleccionar servicio</option>
                                    {% for s in servicios %}
                                    <option value="{{ s.id }}" data-precio="{{ s.precio }}" data-descripcion="{{ s.descripcion|default:'' }}" data-especialidades="{% for esp in s.especialidades_requeridas.all %}{{ esp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                                        {{ s.nombre }}{% if s.precio %} - ${{ s.precio }}{% endif %}{% if s.descripcion %} | {{ s.descripcion|truncatewords:8 }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="mt-2">
                                    <label class="form-label">Descripción:</label>
                                    <div id="servicio-descripcion" class="form-control bg-light" style="min-height:60px;" readonly></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="nombre_cliente" class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email_cliente" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email_cliente" name="email_cliente" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="telefono_cliente" class="form-label">Teléfono</label>
                                    <input type="text" class="form-control" id="telefono_cliente" name="telefono_cliente">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fecha_servicio" class="form-label">Fecha y Hora de la Cita *</label>
                                <div class="row">
                                    <div class="col-7">
                                        <input type="date" class="form-control fecha-cita-input" id="fecha_servicio" name="fecha_servicio" required>
                                        <small class="form-text text-muted">Desde hoy hasta máximo 1 mes</small>
                                    </div>
                                    <div class="col-5">
                                        <select class="form-select hora-cita-select" id="hora" name="hora" required>
                                            <option value="">Seleccionar hora</option>
                                        </select>
                                        <small class="form-text text-muted">Lun-Vie: 9:00 AM - 7:00 PM | Sáb: 10:00 AM - 2:00 PM</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="costo" class="form-label">Costo del Tratamiento *</label>
                                <input type="number" class="form-control" id="costo_admin" name="costo" step="0.01" required>
                                <div id="descuento-cumpleanos-admin" class="mt-2" style="display: none;">
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-birthday-cake me-2"></i>
                                        <strong>¡Descuento del 20% aplicado por mes de cumpleaños!</strong>
                                        <div class="mt-1">
                                            <small>Costo original: $<span id="costo-original-admin"></span></small><br>
                                            <small>Descuento: -$<span id="monto-descuento-admin"></span> (20%)</small><br>
                                            <strong>Costo final: $<span id="costo-final-admin"></span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="estado" class="form-label">Estado *</label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="pendiente">Pendiente</option>
                                <option value="en_progreso">En Progreso</option>
                                <option value="completado">Completado</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Guardar Cita
                            </button>
                            <a href="{% url 'servicios_lista' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                        {% else %}
                        <!-- Cliente/usuario booking form -->
                        <div class="mb-3">
                            <label for="servicio" class="form-label">Seleccionar Servicio *</label>
                            <select class="form-select" id="servicio" name="servicio" required>
                                <option value="">Seleccionar servicio</option>
                                {% for s in servicios %}
                                <option value="{{ s.id }}" data-precio="{{ s.precio }}" data-descripcion="{{ s.descripcion|default:'' }}" data-especialidades="{% for esp in s.especialidades_requeridas.all %}{{ esp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                                    {{ s.nombre }}{% if s.precio %} - ${{ s.precio }}{% endif %}{% if s.descripcion %} | {{ s.descripcion|truncatewords:8 }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                <label class="form-label">Descripción:</label>
                                <div id="servicio-descripcion" class="form-control bg-light" style="min-height:60px;" readonly></div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">Costo:</label>
                                <input type="text" class="form-control bg-light" id="costo" name="costo" readonly>
                                <div id="descuento-cumpleanos" class="mt-2" style="display: none;">
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-birthday-cake me-2"></i>
                                        <strong>¡Descuento del 20% aplicado por mes de cumpleaños!</strong>
                                        <div class="mt-1">
                                            <small>Costo original: $<span id="costo-original"></span></small><br>
                                            <small>Descuento: -$<span id="monto-descuento"></span> (20%)</small><br>
                                            <strong>Costo final: $<span id="costo-final"></span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="empleado" class="form-label">Seleccionar Estilista *</label>
                            <select class="form-select" id="empleado" name="empleado" required>
                                <option value="">Seleccionar empleado</option>
                                {% for e in empleados %}
                                <option value="{{ e.id }}" data-especialidades="{% for esp in e.especialidades.all %}{{ esp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ e.nombre }}{% if e.apellido %} {{ e.apellido }}{% endif %}{% if e.especialidades.all %} - {% for esp in e.especialidades.all|slice:":3" %}{{ esp.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}{% elif e.cargo %} - {{ e.cargo }}{% elif e.especialidad %} - {{ e.especialidad }}{% endif %}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted d-block mt-1" id="empleado-ayuda">
                                Selecciona un servicio primero para ver los empleados disponibles
                            </small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fecha_servicio" class="form-label">Fecha y Hora *</label>
                                <div class="row">
                                    <div class="col-7">
                                        <input type="date" class="form-control fecha-cita-input" id="fecha_servicio_cliente" name="fecha_servicio" required>
                                        <small class="form-text text-muted">Desde hoy hasta máximo 1 mes</small>
                                    </div>
                                    <div class="col-5">
                                        <select class="form-select hora-cita-select" id="hora_cliente" name="hora" required>
                                            <option value="">Seleccionar hora</option>
                                        </select>
                                        <small class="form-text text-muted">Lun-Vie: 9:00 AM - 7:00 PM | Sáb: 10:00 AM - 2:00 PM</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="nombre_cliente" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email_cliente" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email_cliente" name="email_cliente" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="telefono_cliente" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono_cliente" name="telefono_cliente">
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">Agendar Cita</button>
                            <a href="{% url 'inicio' %}" class="btn btn-secondary btn-lg">Cancelar</a>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function(){
    // ========== DETECTAR MODO ADMIN O CLIENTE ==========
    var adminMode = false;
    {% if admin_mode %}
    adminMode = true;
    {% endif %}
    
    // ========== ACTUALIZAR DESCRIPCIÓN Y COSTO DEL SERVICIO ==========
    const servicioSelect = document.querySelector('select[name="servicio"]');
    const descripcionDiv = document.getElementById('servicio-descripcion');
    const costoInput = document.getElementById('costo') || document.getElementById('costo_admin');
    
    if (servicioSelect) {
        function updateDescripcionYCosto(){
            const opt = servicioSelect.options[servicioSelect.selectedIndex];
            
            if (!opt || !opt.value) {
                if (descripcionDiv) descripcionDiv.textContent = 'Sin descripción disponible.';
                if (costoInput) costoInput.value = '';
                return;
            }
            
            const descripcion = opt.getAttribute('data-descripcion') || '';
            const precio = opt.getAttribute('data-precio') || '';
            
            if (descripcionDiv) {
                descripcionDiv.textContent = descripcion || 'Sin descripción disponible.';
            }
            
            if (costoInput) {
                costoInput.value = precio || '';
            }
        }
        
        servicioSelect.addEventListener('change', function() {
            updateDescripcionYCosto();
            filtrarEmpleadosPorServicio();
            setTimeout(verificarDescuentoCumpleanos, 100);
        });
        updateDescripcionYCosto();
        setTimeout(verificarDescuentoCumpleanos, 100);
    }
    
    // ========== DESCUENTO POR CUMPLEAÑOS (Deshabilitado - funcionalidad de clientes eliminada) ==========
    const fechaNacimientoCliente = '';
    const ultimoMesDescuento = '';
    const fechaServicioInput = document.getElementById('fecha_servicio_cliente') || document.getElementById('fecha_servicio');
    const descuentoCumpleanosDiv = document.getElementById('descuento-cumpleanos');
    
    function verificarDescuentoCumpleanos() {
        // Solo verificar descuento si estamos en modo cliente (no admin)
        // Si estamos en modo admin o no tenemos los elementos necesarios, no verificar descuento
        if (adminMode) {
            if (descuentoCumpleanosDiv) descuentoCumpleanosDiv.style.display = 'none';
            return;
        }
        
        if (!fechaNacimientoCliente || fechaNacimientoCliente === '' || !fechaServicioInput || !costoInput) {
            if (descuentoCumpleanosDiv) descuentoCumpleanosDiv.style.display = 'none';
            return;
        }
        
        const fechaServicio = fechaServicioInput.value;
        if (!fechaServicio) {
            if (descuentoCumpleanosDiv) descuentoCumpleanosDiv.style.display = 'none';
            return;
        }
        
        // Obtener el precio original del servicio, no del input de costo
        const servicioSelect = document.querySelector('select[name="servicio"]');
        if (!servicioSelect || !servicioSelect.value) {
            if (descuentoCumpleanosDiv) descuentoCumpleanosDiv.style.display = 'none';
            return;
        }
        
        const servicioOpt = servicioSelect.options[servicioSelect.selectedIndex];
        const precioOriginal = parseFloat(servicioOpt.getAttribute('data-precio')) || 0;
        
        if (precioOriginal === 0) {
            if (descuentoCumpleanosDiv) descuentoCumpleanosDiv.style.display = 'none';
            return;
        }
        
        // Comparar mes de la fecha de servicio con el mes de cumpleaños del cliente
        const fechaServicioObj = new Date(fechaServicio + 'T00:00:00');
        const fechaNacimientoObj = new Date(fechaNacimientoCliente + 'T00:00:00');
        
        // Verificar si está en el mes de cumpleaños (solo comparar mes, no día)
        const esMesCumpleanos = fechaServicioObj.getMonth() === fechaNacimientoObj.getMonth();
        
        if (!esMesCumpleanos) {
            if (descuentoCumpleanosDiv) descuentoCumpleanosDiv.style.display = 'none';
            costoInput.value = precioOriginal;
            return;
        }
        
        // Descuento de cumpleaños deshabilitado (funcionalidad de clientes eliminada)
        if (descuentoCumpleanosDiv) {
            descuentoCumpleanosDiv.style.display = 'none';
        }
        costoInput.value = precioOriginal;
    }
    
    // Verificar descuento cuando cambia la fecha (solo en modo cliente)
    if (!adminMode && fechaServicioInput) {
        fechaServicioInput.addEventListener('change', verificarDescuentoCumpleanos);
        setTimeout(verificarDescuentoCumpleanos, 500);
    }
    
    
    // ========== FILTRAR EMPLEADOS POR SERVICIO SELECCIONADO ==========
    function filtrarEmpleadosPorServicio() {
        const servicioSelect = document.querySelector('select[name="servicio"]');
        const empleadoSelect = document.getElementById('empleado') || document.getElementById('empleado_admin');
        const ayudaEmpleado = document.getElementById('empleado-ayuda') || document.getElementById('empleado-admin-ayuda');
        
        if (!servicioSelect || !empleadoSelect) return;
        
        const servicioOpt = servicioSelect.options[servicioSelect.selectedIndex];
        if (!servicioOpt || !servicioOpt.value) {
            // Si no hay servicio seleccionado, mostrar todos los empleados
            Array.from(empleadoSelect.options).forEach(opt => {
                if (opt.value) opt.style.display = '';
            });
            if (ayudaEmpleado) ayudaEmpleado.textContent = 'Selecciona un servicio primero para ver los empleados disponibles';
            empleadoSelect.value = '';
            return;
        }
        
        const especialidadesRequeridasStr = servicioOpt.getAttribute('data-especialidades') || '';
        const especialidadesRequeridas = especialidadesRequeridasStr ? especialidadesRequeridasStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id)) : [];
        
        let empleadosDisponibles = 0;
        
        // Filtrar empleados
        Array.from(empleadoSelect.options).forEach(opt => {
            if (!opt.value) {
                opt.style.display = '';
                return;
            }
            
            const especialidadesEmpleadoStr = opt.getAttribute('data-especialidades') || '';
            const especialidadesEmpleado = especialidadesEmpleadoStr ? especialidadesEmpleadoStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id)) : [];
            
            // Si el servicio no tiene especialidades requeridas, mostrar todos los empleados
            if (especialidadesRequeridas.length === 0) {
                opt.style.display = '';
                empleadosDisponibles++;
            } else {
                // Verificar si el empleado tiene al menos una de las especialidades requeridas
                const tieneEspecialidad = especialidadesRequeridas.some(espId => especialidadesEmpleado.includes(espId));
                if (tieneEspecialidad) {
                    opt.style.display = '';
                    empleadosDisponibles++;
                } else {
                    opt.style.display = 'none';
                }
            }
        });
        
        // Actualizar mensaje de ayuda
        if (ayudaEmpleado) {
            if (empleadosDisponibles === 0) {
                ayudaEmpleado.textContent = '⚠️ No hay empleados disponibles con las especialidades requeridas para este servicio.';
                ayudaEmpleado.className = 'form-text text-warning d-block mt-1';
            } else {
                ayudaEmpleado.textContent = `✓ ${empleadosDisponibles} empleado(s) disponible(s) para este servicio`;
                ayudaEmpleado.className = 'form-text text-success d-block mt-1';
            }
        }
        
        // Limpiar selección si el empleado actual no está disponible
        if (empleadoSelect.value) {
            const selectedOpt = empleadoSelect.options[empleadoSelect.selectedIndex];
            if (selectedOpt && selectedOpt.style.display === 'none') {
                empleadoSelect.value = '';
            }
        }
    }
    
    // Filtrar empleados cuando se carga la página si ya hay un servicio seleccionado
    setTimeout(filtrarEmpleadosPorServicio, 100);
    
    // ========== VALIDACIÓN DEL FORMULARIO ANTES DE ENVIAR ==========
    const form = document.querySelector('form[method="POST"]');
    
    if (form) {
        // Crear contenedor para mensaje de error
        let mensajeErrorDiv = document.getElementById('mensaje-validacion');
        if (!mensajeErrorDiv) {
            mensajeErrorDiv = document.createElement('div');
            mensajeErrorDiv.id = 'mensaje-validacion';
            mensajeErrorDiv.className = 'alert alert-danger d-none mb-3';
            mensajeErrorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Error:</strong> <span id="mensaje-error-texto"></span>';
            
            // Insertar el mensaje de error antes de los botones
            const buttonsContainer = form.querySelector('.d-flex.gap-2');
            if (buttonsContainer) {
                buttonsContainer.parentElement.insertBefore(mensajeErrorDiv, buttonsContainer);
            }
        }
        
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir el envío por defecto
            
            // Limpiar clases de error previas
            form.querySelectorAll('.is-invalid').forEach(campo => {
                campo.classList.remove('is-invalid');
            });
            
            // Ocultar mensaje anterior
            mensajeErrorDiv.classList.add('d-none');
            
            // Validar campos requeridos
            const camposFaltantes = [];
            const errores = [];
            
            // Servicio
            const servicioSelect = form.querySelector('select[name="servicio"]');
            if (!servicioSelect || !servicioSelect.value || servicioSelect.value.trim() === '') {
                camposFaltantes.push('Servicio');
                if (servicioSelect) servicioSelect.classList.add('is-invalid');
            }
            
            // Empleado (Estilista)
            const empleadoSelect = form.querySelector('select[name="empleado"]') || 
                                   document.getElementById('empleado') || 
                                   document.getElementById('empleado_admin');
            if (!empleadoSelect || !empleadoSelect.value || empleadoSelect.value.trim() === '') {
                camposFaltantes.push('Estilista');
                if (empleadoSelect) empleadoSelect.classList.add('is-invalid');
            }
            
            // Fecha
            const fechaInput = form.querySelector('input[name="fecha_servicio"]') || 
                              document.getElementById('fecha_servicio_cliente') ||
                              document.getElementById('fecha_servicio');
            if (!fechaInput || !fechaInput.value || fechaInput.value.trim() === '') {
                camposFaltantes.push('Fecha');
                if (fechaInput) fechaInput.classList.add('is-invalid');
            }
            
            // Hora
            const horaSelect = form.querySelector('select[name="hora"]') || 
                              document.getElementById('hora_cliente') ||
                              document.getElementById('hora');
            if (!horaSelect || !horaSelect.value || horaSelect.value.trim() === '') {
                camposFaltantes.push('Hora');
                if (horaSelect) horaSelect.classList.add('is-invalid');
            }
            
            // Nombre cliente (solo modo cliente)
            const nombreInput = form.querySelector('input[name="nombre_cliente"]') || 
                               document.getElementById('nombre_cliente');
            if (nombreInput && (!nombreInput.value || nombreInput.value.trim() === '')) {
                camposFaltantes.push('Nombre');
                nombreInput.classList.add('is-invalid');
            }
            
            // Email cliente (solo modo cliente)
            const emailInput = form.querySelector('input[name="email_cliente"]') || 
                              document.getElementById('email_cliente');
            if (emailInput && (!emailInput.value || emailInput.value.trim() === '')) {
                camposFaltantes.push('Email');
                emailInput.classList.add('is-invalid');
            }
            
            // Costo
            const costoInput = form.querySelector('input[name="costo"]') || 
                              document.getElementById('costo') ||
                              document.getElementById('costo_admin');
            if (!costoInput || !costoInput.value || costoInput.value.trim() === '' || parseFloat(costoInput.value) <= 0) {
                camposFaltantes.push('Costo');
                if (costoInput) costoInput.classList.add('is-invalid');
            }
            
            if (camposFaltantes.length > 0) {
                // Mostrar mensaje de error sin recargar la página
                const textoError = 'Faltan los siguientes campos requeridos: ' + camposFaltantes.join(', ');
                mensajeErrorDiv.querySelector('#mensaje-error-texto').textContent = textoError;
                mensajeErrorDiv.classList.remove('d-none');
                
                // Hacer scroll al mensaje de error
                mensajeErrorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Remover clases de error cuando el usuario empiece a escribir
                form.querySelectorAll('.is-invalid').forEach(campo => {
                    campo.addEventListener('input', function() {
                        this.classList.remove('is-invalid');
                    }, { once: true });
                    campo.addEventListener('change', function() {
                        this.classList.remove('is-invalid');
                    }, { once: true });
                });
                
                return false;
            }
            
            // Si todos los campos están llenos, permitir el envío del formulario
            // Guardar el estado del descuento antes de enviar
            let descuentoAplicado = false;
            let costoConDescuento = null;
            if (descuentoCumpleanosDiv && descuentoCumpleanosDiv.style.display !== 'none' && costoInput) {
                descuentoAplicado = true;
                costoConDescuento = costoInput.value;
            }
            
            // Crear un input hidden para preservar el descuento
            if (descuentoAplicado && costoConDescuento) {
                let descuentoHidden = form.querySelector('input[name="descuento_aplicado"]');
                if (!descuentoHidden) {
                    descuentoHidden = document.createElement('input');
                    descuentoHidden.type = 'hidden';
                    descuentoHidden.name = 'descuento_aplicado';
                    form.appendChild(descuentoHidden);
                }
                descuentoHidden.value = 'true';
            }
            
            // Permitir el envío del formulario
            form.submit();
        });
    }
    
    // ========== VALIDACIÓN DE FECHA Y HORA ==========
    // Horarios de atención:
    // Lunes a Viernes: 9:00 AM - 7:00 PM (9:00 - 19:00)
    // Sábado: 10:00 AM - 2:00 PM (10:00 - 14:00)
    // Domingo: Cerrado
    
    // Configurar límites de fecha (hoy hasta 1 mes)
    const hoy = new Date();
    const fechaMaxima = new Date();
    fechaMaxima.setDate(fechaMaxima.getDate() + 30); // 30 días desde hoy (1 mes)
    
    // Formatear fechas para input date (YYYY-MM-DD)
    function formatearFecha(fecha) {
        const año = fecha.getFullYear();
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const dia = String(fecha.getDate()).padStart(2, '0');
        return `${año}-${mes}-${dia}`;
    }
    
    // Obtener el día de la semana (0 = Domingo, 1 = Lunes, ..., 6 = Sábado)
    function obtenerDiaSemana(fecha) {
        return fecha.getDay();
    }
    
    // Generar opciones de hora según el día de la semana
    function generarOpcionesHora(diaSemana) {
        const horas = [];
        
        if (diaSemana === 0) {
            // Domingo: Cerrado - no hay horas disponibles
            return [];
        } else if (diaSemana === 6) {
            // Sábado: 10:00 - 14:00
            for (let hora = 10; hora < 14; hora++) {
                horas.push(`${String(hora).padStart(2, '0')}:00`);
                horas.push(`${String(hora).padStart(2, '0')}:30`);
            }
            horas.push('14:00');
        } else {
            // Lunes a Viernes: 9:00 - 19:00
            for (let hora = 9; hora < 19; hora++) {
                horas.push(`${String(hora).padStart(2, '0')}:00`);
                horas.push(`${String(hora).padStart(2, '0')}:30`);
            }
            horas.push('19:00');
        }
        
        return horas;
    }
    
    // Función para actualizar las opciones de hora según la fecha
    function actualizarOpcionesHora(fechaInput, horaSelect) {
        if (!fechaInput || !horaSelect) return;
        
        // Limpiar opciones existentes (excepto la primera)
        while (horaSelect.options.length > 1) {
            horaSelect.remove(1);
        }
        
        const fechaSeleccionada = fechaInput.value ? new Date(fechaInput.value + 'T00:00:00') : null;
        const fechaHoy = new Date();
        fechaHoy.setHours(0, 0, 0, 0);
        
        // Verificar si es domingo
        if (fechaSeleccionada) {
            const diaSemana = obtenerDiaSemana(fechaSeleccionada);
            if (diaSemana === 0) {
                // Domingo: Cerrado
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Domingo: Cerrado';
                option.disabled = true;
                horaSelect.appendChild(option);
                return;
            }
        }
        
        // Obtener empleado seleccionado
        const empleadoSelect = document.getElementById('empleado') || document.getElementById('empleado_admin');
        const empleadoId = empleadoSelect ? empleadoSelect.value : null;
        
        // Si no hay fecha o empleado, generar horas básicas sin filtrar ocupadas
        if (!fechaSeleccionada || !fechaInput.value || !empleadoId) {
            const diaSemana = fechaSeleccionada ? obtenerDiaSemana(fechaSeleccionada) : 1;
            const todasLasHoras = generarOpcionesHora(diaSemana);
            agregarOpcionesHora(horaSelect, todasLasHoras, null, []);
            return;
        }
        
        // Obtener día de la semana para generar horas apropiadas
        const diaSemana = fechaSeleccionada ? obtenerDiaSemana(fechaSeleccionada) : null;
        const todasLasHoras = generarOpcionesHora(diaSemana || 1);
        
        // Determinar hora mínima permitida
        let horaMinimaPermitida = null;
        if (fechaSeleccionada) {
            fechaSeleccionada.setHours(0, 0, 0, 0);
            if (fechaSeleccionada.getTime() === fechaHoy.getTime()) {
                // Si es hoy, calcular hora mínima
                const ahora = new Date();
                let horaActual = ahora.getHours();
                let minutoActual = ahora.getMinutes();
                
                // Redondear al siguiente intervalo de 30 minutos
                if (minutoActual > 30) {
                    horaActual += 1;
                    minutoActual = 0;
                } else if (minutoActual > 0) {
                    minutoActual = 30;
                }
                
                horaMinimaPermitida = `${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`;
            }
        }
        
        // Consultar horas ocupadas del servidor
        const fechaStr = fechaInput.value;
        fetch(`{% url 'obtener_horas_ocupadas' %}?empleado_id=${empleadoId}&fecha=${fechaStr}`)
            .then(response => response.json())
            .then(data => {
                const horasOcupadas = data.horas_ocupadas || [];
                agregarOpcionesHora(horaSelect, todasLasHoras, horaMinimaPermitida, horasOcupadas);
            })
            .catch(error => {
                console.error('Error al obtener horas ocupadas:', error);
                // En caso de error, mostrar todas las horas sin filtrar ocupadas
                agregarOpcionesHora(horaSelect, todasLasHoras, horaMinimaPermitida, []);
            });
    }
    
    // Función auxiliar para agregar opciones de hora al select
    function agregarOpcionesHora(horaSelect, todasLasHoras, horaMinimaPermitida, horasOcupadas) {
        // Limpiar opciones existentes (excepto la primera)
        while (horaSelect.options.length > 1) {
            horaSelect.remove(1);
        }
        
        let opcionesAgregadas = 0;
        todasLasHoras.forEach(hora => {
            // Filtrar horas pasadas si es hoy
            if (horaMinimaPermitida) {
                const [horaMin, minutoMin] = horaMinimaPermitida.split(':').map(Number);
                const [horaAct, minutoAct] = hora.split(':').map(Number);
                const minutosMinimos = horaMin * 60 + minutoMin;
                const minutosActuales = horaAct * 60 + minutoAct;
                
                if (minutosActuales < minutosMinimos) {
                    return;
                }
            }
            
            // Filtrar horas ocupadas
            if (horasOcupadas.includes(hora)) {
                return; // No agregar esta hora si está ocupada
            }
            
            const option = document.createElement('option');
            option.value = hora;
            
            // Formatear hora para mostrar en formato AM/PM
            const [horaNum, minuto] = hora.split(':');
            const horaInt = parseInt(horaNum);
            let horaMostrar;
            if (horaInt === 0) {
                horaMostrar = `12:${minuto} AM`;
            } else if (horaInt < 12) {
                horaMostrar = `${horaInt}:${minuto} AM`;
            } else if (horaInt === 12) {
                horaMostrar = `12:${minuto} PM`;
            } else {
                // Horas de 13:00 en adelante (1:00 PM, 2:00 PM, etc.)
                const horaPM = horaInt - 12;
                horaMostrar = `${horaPM}:${minuto} PM`;
            }
            option.textContent = horaMostrar;
            horaSelect.appendChild(option);
            opcionesAgregadas++;
        });
        
        if (opcionesAgregadas === 0) {
            const option = document.createElement('option');
            option.value = '';
            const fechaInput = document.querySelector('.fecha-cita-input');
            const fechaSeleccionada = fechaInput && fechaInput.value ? new Date(fechaInput.value + 'T00:00:00') : null;
            if (fechaSeleccionada && obtenerDiaSemana(fechaSeleccionada) === 0) {
                option.textContent = 'Domingo: Cerrado';
            } else {
                option.textContent = 'No hay horarios disponibles para este día';
            }
            option.disabled = true;
            horaSelect.appendChild(option);
        }
    }
    
    // Configurar todos los inputs de fecha
    const fechaInputs = document.querySelectorAll('.fecha-cita-input');
    const horaSelects = document.querySelectorAll('.hora-cita-select');
    
    // Función para bloquear domingos en el input de fecha
    function bloquearDomingos(input) {
        input.addEventListener('input', function() {
            if (this.value) {
                const fechaSeleccionada = new Date(this.value + 'T00:00:00');
                const diaSemana = obtenerDiaSemana(fechaSeleccionada);
                
                if (diaSemana === 0) {
                    // Es domingo, mostrar mensaje y limpiar
                    alert('Los domingos la clínica está cerrada. Por favor selecciona otro día.');
                    this.value = '';
                    // Limpiar también el select de hora
                    const contenedor = this.closest('.row');
                    if (contenedor) {
                        const horaSelect = contenedor.querySelector('.hora-cita-select');
                        if (horaSelect) {
                            while (horaSelect.options.length > 1) {
                                horaSelect.remove(1);
                            }
                        }
                    }
                }
            }
        });
    }
    
    fechaInputs.forEach((fechaInput, index) => {
        // Configurar min y max para fecha
        fechaInput.setAttribute('min', formatearFecha(hoy));
        fechaInput.setAttribute('max', formatearFecha(fechaMaxima));
        
        // Bloquear domingos
        bloquearDomingos(fechaInput);
        
        // Buscar select de hora correspondiente
        let horaSelect = horaSelects[index];
        if (!horaSelect) {
            // Buscar en el mismo contenedor
            const contenedor = fechaInput.closest('.row');
            if (contenedor) {
                horaSelect = contenedor.querySelector('.hora-cita-select');
            }
        }
        
        if (horaSelect) {
            // Cargar horas iniciales (todas si no hay fecha)
            actualizarOpcionesHora(fechaInput, horaSelect);
            
            // Actualizar cuando cambia la fecha
            fechaInput.addEventListener('change', function() {
                actualizarOpcionesHora(fechaInput, horaSelect);
                // Si estamos en modo cliente, verificar descuento también
                if (!adminMode) {
                    setTimeout(verificarDescuentoCumpleanos, 200);
                }
            });
        }
    });
    
    // Actualizar horas cuando cambia el empleado seleccionado
    const empleadoSelect = document.getElementById('empleado') || document.getElementById('empleado_admin');
    if (empleadoSelect) {
        empleadoSelect.addEventListener('change', function() {
            // Actualizar horas para todos los selects de hora si hay fecha seleccionada
            fechaInputs.forEach((fechaInput) => {
                if (fechaInput.value) {
                    const contenedor = fechaInput.closest('.row');
                    if (contenedor) {
                        const horaSelect = contenedor.querySelector('.hora-cita-select');
                        if (horaSelect) {
                            actualizarOpcionesHora(fechaInput, horaSelect);
                        }
                    }
                }
            });
        });
    }
    
    // Cargar horas para selects que no tienen fecha asociada (por defecto Lunes-Viernes)
    horaSelects.forEach((horaSelect) => {
        if (horaSelect.options.length === 1) {
            const todasLasHoras = generarOpcionesHora(1); // Lunes por defecto
            todasLasHoras.forEach(hora => {
                const option = document.createElement('option');
                option.value = hora;
                // Formatear hora para mostrar en formato AM/PM
                const [horaNum, minuto] = hora.split(':');
                const horaInt = parseInt(horaNum);
                let horaMostrar;
                if (horaInt === 0) {
                    horaMostrar = `12:${minuto} AM`;
                } else if (horaInt < 12) {
                    horaMostrar = `${horaInt}:${minuto} AM`;
                } else if (horaInt === 12) {
                    horaMostrar = `12:${minuto} PM`;
                } else {
                    // Horas de 13:00 en adelante (1:00 PM, 2:00 PM, etc.)
                    const horaPM = horaInt - 12;
                    horaMostrar = `${horaPM}:${minuto} PM`;
                }
                option.textContent = horaMostrar;
                horaSelect.appendChild(option);
            });
        }
    });
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block titulo %}Agendar Cita - Administrador{% endblock %}

{% block contenido %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="display-5 mb-4">
                <i class="fas fa-calendar-plus text-success me-2"></i>Agendar Nueva Cita
            </h1>

            <div class="card shadow">
                <div class="card-body p-4">
                    <form method="POST" novalidate>
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="empleado" class="form-label">Especialista *</label>
                                <select class="form-select" id="empleado" name="empleado" required>
                                    <option value="">Seleccionar especialista</option>
                                    {% for e in empleados %}
                                    <option value="{{ e.id }}" data-especialidades="{% for esp in e.especialidades.all %}{{ esp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ e.nombre }}{% if e.apellido %} {{ e.apellido }}{% endif %}{% if e.especialidades.all %} - {% for esp in e.especialidades.all|slice:":3" %}{{ esp.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}{% elif e.cargo %} - {{ e.cargo }}{% elif e.especialidad %} - {{ e.especialidad }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted d-block mt-1" id="empleado-crear-ayuda">
                                    Selecciona un servicio primero para ver los empleados disponibles
                                </small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="servicio" class="form-label">Servicio *</label>
                                <select class="form-select" id="servicio" name="servicio" required>
                                    <option value="">Seleccionar servicio</option>
                                    {% for s in servicios %}
                                    <option value="{{ s.id }}" data-precio="{{ s.precio }}" data-descripcion="{{ s.descripcion|default:'' }}" data-especialidades="{% for esp in s.especialidades_requeridas.all %}{{ esp.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ s.nombre }}{% if s.precio %} - ${{ s.precio }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                                <div class="mt-2">
                                    <label class="form-label">Descripción:</label>
                                    <div id="servicio-descripcion" class="form-control bg-light" style="min-height:60px;" readonly></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="cliente_id" class="form-label">Cliente *</label>
                                {% if clientes %}
                                <!-- Campo de búsqueda por RUT -->
                                <div class="mb-2">
                                    <label for="filtro_rut" class="form-label small text-muted">
                                        <i class="fas fa-search me-1"></i>Buscar por RUT
                                    </label>
                                    <input type="text" class="form-control form-control-sm" id="filtro_rut" 
                                           placeholder="Ingrese RUT para filtrar (ej: 12345678-5)" 
                                           autocomplete="off">
                                    <small class="form-text text-muted">Escriba el RUT para filtrar la lista de clientes</small>
                                </div>
                                
                                <select class="form-select" id="cliente_id" name="cliente_id" required size="8" style="min-height: 200px;">
                                    <option value="">Seleccionar cliente</option>
                                    {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" 
                                            data-rut="{{ cliente.rut|lower }}"
                                            data-nombre="{{ cliente.nombre|lower }}">
                                        {{ cliente.nombre }} - {{ cliente.rut }}{% if cliente.email %} ({{ cliente.email }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Solo se muestran clientes activos registrados en el sistema</small>
                                {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No hay clientes activos registrados. 
                                    <a href="{% url 'clientes_crear' %}" class="alert-link">Crear un nuevo cliente</a> primero.
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="fecha_servicio" class="form-label">Fecha de la Cita *</label>
                                <input type="date" class="form-control" id="fecha_servicio" name="fecha_servicio" required>
                                <small class="form-text text-muted">Desde hoy hasta máximo 1 mes</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="hora" class="form-label">Hora de la Cita *</label>
                                <select class="form-select" id="hora" name="hora" required>
                                    <option value="">Seleccionar hora</option>
                                </select>
                                <small class="form-text text-muted">Lun-Vie: 9:00 AM - 7:00 PM | Sáb: 10:00 AM - 2:00 PM</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="costo" class="form-label">Costo del Tratamiento *</label>
                                <input type="number" class="form-control" id="costo" name="costo" step="0.01" required readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="estado" class="form-label">Estado *</label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="pendiente">Pendiente</option>
                                <option value="en_progreso">En Progreso</option>
                                <option value="completado">Completado</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Guardar Cita
                            </button>
                            <a href="{% url 'servicios_lista' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                        <script>
                        document.addEventListener('DOMContentLoaded', function(){
                            const servicioSelect = document.getElementById('servicio');
                            const costoInput = document.getElementById('costo');
                            const descripcionDiv = document.getElementById('servicio-descripcion');
                            const clienteSelect = document.getElementById('cliente_id');
                            const filtroRut = document.getElementById('filtro_rut');
                            const fechaInput = document.getElementById('fecha_servicio');
                            const horaSelect = document.getElementById('hora');
                            
                            // Horarios de atención:
                            // Lunes a Viernes: 9:00 AM - 7:00 PM (9:00 - 19:00)
                            // Sábado: 10:00 AM - 2:00 PM (10:00 - 14:00)
                            // Domingo: Cerrado
                            
                            // Obtener el día de la semana (0 = Domingo, 1 = Lunes, ..., 6 = Sábado)
                            function obtenerDiaSemana(fecha) {
                                return fecha.getDay();
                            }
                            
                            // Generar opciones de hora según el día de la semana
                            function generarOpcionesHora(diaSemana) {
                                const horas = [];
                                
                                if (diaSemana === 0) {
                                    // Domingo: Cerrado - no hay horas disponibles
                                    return [];
                                } else if (diaSemana === 6) {
                                    // Sábado: 10:00 - 14:00
                                    for (let hora = 10; hora < 14; hora++) {
                                        horas.push(`${String(hora).padStart(2, '0')}:00`);
                                        horas.push(`${String(hora).padStart(2, '0')}:30`);
                                    }
                                    horas.push('14:00');
                                } else {
                                    // Lunes a Viernes: 9:00 - 19:00
                                    for (let hora = 9; hora < 19; hora++) {
                                        horas.push(`${String(hora).padStart(2, '0')}:00`);
                                        horas.push(`${String(hora).padStart(2, '0')}:30`);
                                    }
                                    horas.push('19:00');
                                }
                                
                                return horas;
                            }
                            
                            // Configurar límites de fecha (hoy hasta 1 mes)
                            const hoy = new Date();
                            const fechaMaxima = new Date();
                            fechaMaxima.setDate(fechaMaxima.getDate() + 30); // 30 días desde hoy (1 mes)
                            
                            // Formatear fechas para input date (YYYY-MM-DD)
                            const formatearFecha = (fecha) => {
                                const año = fecha.getFullYear();
                                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                                const dia = String(fecha.getDate()).padStart(2, '0');
                                return `${año}-${mes}-${dia}`;
                            };
                            
                            // Función para bloquear domingos
                            function bloquearDomingos(input) {
                                input.addEventListener('input', function() {
                                    if (this.value) {
                                        const fechaSeleccionada = new Date(this.value + 'T00:00:00');
                                        const diaSemana = obtenerDiaSemana(fechaSeleccionada);
                                        
                                        if (diaSemana === 0) {
                                            alert('Los domingos la clínica está cerrada. Por favor selecciona otro día.');
                                            this.value = '';
                                            if (horaSelect) {
                                                while (horaSelect.options.length > 1) {
                                                    horaSelect.remove(1);
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                            
                            // Función para actualizar las opciones de hora según la fecha
                            function actualizarOpcionesHora() {
                                if (!fechaInput || !horaSelect) return;
                                
                                // Limpiar opciones existentes (excepto la primera)
                                while (horaSelect.options.length > 1) {
                                    horaSelect.remove(1);
                                }
                                
                                const fechaSeleccionada = fechaInput.value ? new Date(fechaInput.value + 'T00:00:00') : null;
                                const fechaHoy = new Date();
                                fechaHoy.setHours(0, 0, 0, 0);
                                
                                // Verificar si es domingo
                                if (fechaSeleccionada) {
                                    const diaSemana = obtenerDiaSemana(fechaSeleccionada);
                                    if (diaSemana === 0) {
                                        // Domingo: Cerrado
                                        const option = document.createElement('option');
                                        option.value = '';
                                        option.textContent = 'Domingo: Cerrado';
                                        option.disabled = true;
                                        horaSelect.appendChild(option);
                                        return;
                                    }
                                }
                                
                                // Obtener día de la semana para generar horas apropiadas
                                const diaSemana = fechaSeleccionada ? obtenerDiaSemana(fechaSeleccionada) : null;
                                const todasLasHoras = generarOpcionesHora(diaSemana || 1); // Por defecto lunes si no hay fecha
                                
                                // Determinar hora mínima permitida
                                let horaMinimaPermitida = null;
                                if (fechaSeleccionada) {
                                    fechaSeleccionada.setHours(0, 0, 0, 0);
                                    if (fechaSeleccionada.getTime() === fechaHoy.getTime()) {
                                        // Si es hoy, calcular hora mínima
                                        const ahora = new Date();
                                        let horaActual = ahora.getHours();
                                        let minutoActual = ahora.getMinutes();
                                        
                                        // Redondear al siguiente intervalo de 30 minutos
                                        if (minutoActual > 30) {
                                            horaActual += 1;
                                            minutoActual = 0;
                                        } else if (minutoActual > 0) {
                                            minutoActual = 30;
                                        }
                                        
                                        horaMinimaPermitida = `${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`;
                                    }
                                }
                                
                                // Agregar opciones de hora
                                let opcionesAgregadas = 0;
                                todasLasHoras.forEach(hora => {
                                    // Filtrar horas pasadas si es hoy
                                    if (horaMinimaPermitida) {
                                        const [horaMin, minutoMin] = horaMinimaPermitida.split(':').map(Number);
                                        const [horaAct, minutoAct] = hora.split(':').map(Number);
                                        const minutosMinimos = horaMin * 60 + minutoMin;
                                        const minutosActuales = horaAct * 60 + minutoAct;
                                        
                                        if (minutosActuales < minutosMinimos) {
                                            return;
                                        }
                                    }
                                    
                                    const option = document.createElement('option');
                                    option.value = hora;
                                    
                                    // Formatear hora para mostrar en formato AM/PM
                                    const [horaNum, minuto] = hora.split(':');
                                    const horaInt = parseInt(horaNum);
                                    let horaMostrar;
                                    if (horaInt === 0) {
                                        horaMostrar = `12:${minuto} AM`;
                                    } else if (horaInt < 12) {
                                        horaMostrar = `${horaInt}:${minuto} AM`;
                                    } else if (horaInt === 12) {
                                        horaMostrar = `12:${minuto} PM`;
                                    } else {
                                        const horaPM = horaInt - 12;
                                        horaMostrar = `${horaPM}:${minuto} PM`;
                                    }
                                    option.textContent = horaMostrar;
                                    horaSelect.appendChild(option);
                                    opcionesAgregadas++;
                                });
                                
                                if (opcionesAgregadas === 0) {
                                    const option = document.createElement('option');
                                    option.value = '';
                                    if (fechaSeleccionada && obtenerDiaSemana(fechaSeleccionada) === 0) {
                                        option.textContent = 'Domingo: Cerrado';
                                    } else {
                                        option.textContent = 'No hay horarios disponibles para este día';
                                    }
                                    option.disabled = true;
                                    horaSelect.appendChild(option);
                                }
                            }
                            
                            // Configurar min y max para fecha
                            if (fechaInput) {
                                fechaInput.setAttribute('min', formatearFecha(hoy));
                                fechaInput.setAttribute('max', formatearFecha(fechaMaxima));
                                
                                // Bloquear domingos
                                bloquearDomingos(fechaInput);
                                
                                // Actualizar opciones de hora cuando cambia la fecha
                                fechaInput.addEventListener('change', actualizarOpcionesHora);
                                
                                // Inicializar opciones de hora
                                actualizarOpcionesHora();
                            }
                            
                            function updateDescripcion(){
                                const opt = servicioSelect.options[servicioSelect.selectedIndex];
                                const descripcion = opt ? opt.getAttribute('data-descripcion') : '';
                                descripcionDiv.textContent = descripcion || 'Sin descripción disponible.';
                            }
                            
                            // Función para filtrar clientes por RUT
                            function filtrarClientesPorRUT() {
                                if (!clienteSelect || !filtroRut) return;
                                
                                const textoBusqueda = filtroRut.value.toLowerCase().trim().replace(/[.\-]/g, '');
                                const opciones = clienteSelect.options;
                                let encontrado = false;
                                let primeraOpcionVisible = null;
                                
                                // Recorrer todas las opciones (empezando desde índice 1 para saltar la opción vacía)
                                for (let i = 1; i < opciones.length; i++) {
                                    const opcion = opciones[i];
                                    const rutCliente = opcion.getAttribute('data-rut') || '';
                                    const nombreCliente = opcion.getAttribute('data-nombre') || '';
                                    const rutLimpio = rutCliente.replace(/[.\-]/g, '');
                                    
                                    // Mostrar opción si el RUT coincide o si no hay texto de búsqueda
                                    if (textoBusqueda === '' || rutLimpio.includes(textoBusqueda) || nombreCliente.includes(textoBusqueda)) {
                                        opcion.style.display = '';
                                        if (!encontrado && textoBusqueda !== '' && rutLimpio === textoBusqueda) {
                                            // Si hay coincidencia exacta, seleccionar automáticamente
                                            clienteSelect.value = opcion.value;
                                            encontrado = true;
                                        }
                                        if (!primeraOpcionVisible) {
                                            primeraOpcionVisible = opcion;
                                        }
                                    } else {
                                        opcion.style.display = 'none';
                                    }
                                }
                                
                                // Si hay texto de búsqueda y solo hay una opción visible, seleccionarla automáticamente
                                if (textoBusqueda !== '' && !encontrado && primeraOpcionVisible) {
                                    const opcionesVisibles = Array.from(opciones).filter(opt => 
                                        opt.value !== '' && opt.style.display !== 'none'
                                    );
                                    if (opcionesVisibles.length === 1) {
                                        clienteSelect.value = opcionesVisibles[0].value;
                                    }
                                }
                                
                                // Si no hay texto de búsqueda, limpiar selección
                                if (textoBusqueda === '') {
                                    clienteSelect.value = '';
                                }
                            }
                            
                            // Event listener para el filtro de RUT
                            if (filtroRut && clienteSelect) {
                                filtroRut.addEventListener('input', filtrarClientesPorRUT);
                                filtroRut.addEventListener('keyup', function(e) {
                                    // Permitir Enter para confirmar selección
                                    if (e.key === 'Enter') {
                                        e.preventDefault();
                                        if (clienteSelect.value) {
                                            clienteSelect.focus();
                                        }
                                    }
                                });
                            }
                            
                            if(servicioSelect && costoInput && descripcionDiv){
                                servicioSelect.addEventListener('change', function(){
                                    const opt = servicioSelect.options[servicioSelect.selectedIndex];
                                    const precio = opt ? opt.getAttribute('data-precio') : null;
                                    if(precio){
                                        costoInput.value = precio;
                                    } else {
                                        costoInput.value = '';
                                    }
                                    updateDescripcion();
                                    filtrarEmpleadosPorServicioCrear();
                                });
                                // Inicializar costo y descripción si ya hay una opción seleccionada por defecto
                                const initialOpt = servicioSelect.options[servicioSelect.selectedIndex];
                                const initialPrecio = initialOpt ? initialOpt.getAttribute('data-precio') : null;
                                if(initialPrecio){
                                    costoInput.value = initialPrecio;
                                }
                                updateDescripcion();
                            }
                            
                            // ========== FILTRAR EMPLEADOS POR SERVICIO SELECCIONADO ==========
                            function filtrarEmpleadosPorServicioCrear() {
                                const empleadoSelect = document.getElementById('empleado');
                                const ayudaEmpleado = document.getElementById('empleado-crear-ayuda');
                                
                                if (!servicioSelect || !empleadoSelect) return;
                                
                                const servicioOpt = servicioSelect.options[servicioSelect.selectedIndex];
                                if (!servicioOpt || !servicioOpt.value) {
                                    // Si no hay servicio seleccionado, mostrar todos los empleados
                                    Array.from(empleadoSelect.options).forEach(opt => {
                                        if (opt.value) opt.style.display = '';
                                    });
                                    if (ayudaEmpleado) {
                                        ayudaEmpleado.textContent = 'Selecciona un servicio primero para ver los empleados disponibles';
                                        ayudaEmpleado.className = 'form-text text-muted d-block mt-1';
                                    }
                                    empleadoSelect.value = '';
                                    return;
                                }
                                
                                const especialidadesRequeridasStr = servicioOpt.getAttribute('data-especialidades') || '';
                                const especialidadesRequeridas = especialidadesRequeridasStr ? especialidadesRequeridasStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id) && id > 0) : [];
                                
                                let empleadosDisponibles = 0;
                                
                                // Filtrar empleados
                                Array.from(empleadoSelect.options).forEach(opt => {
                                    if (!opt.value) {
                                        opt.style.display = '';
                                        return;
                                    }
                                    
                                    const especialidadesEmpleadoStr = opt.getAttribute('data-especialidades') || '';
                                    const especialidadesEmpleado = especialidadesEmpleadoStr ? especialidadesEmpleadoStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id) && id > 0) : [];
                                    
                                    // Si el servicio no tiene especialidades requeridas, mostrar todos los empleados
                                    if (especialidadesRequeridas.length === 0) {
                                        opt.style.display = '';
                                        empleadosDisponibles++;
                                    } else {
                                        // Verificar si el empleado tiene al menos una de las especialidades requeridas
                                        const tieneEspecialidad = especialidadesRequeridas.some(espId => especialidadesEmpleado.includes(espId));
                                        if (tieneEspecialidad) {
                                            opt.style.display = '';
                                            empleadosDisponibles++;
                                        } else {
                                            opt.style.display = 'none';
                                        }
                                    }
                                });
                                
                                // Actualizar mensaje de ayuda
                                if (ayudaEmpleado) {
                                    if (empleadosDisponibles === 0) {
                                        if (especialidadesRequeridas.length > 0) {
                                            ayudaEmpleado.textContent = '⚠️ No hay empleados disponibles con las especialidades requeridas para este servicio.';
                                            ayudaEmpleado.className = 'form-text text-warning d-block mt-1';
                                        } else {
                                            ayudaEmpleado.textContent = 'Selecciona un servicio para ver los empleados disponibles';
                                            ayudaEmpleado.className = 'form-text text-muted d-block mt-1';
                                        }
                                    } else {
                                        ayudaEmpleado.textContent = `✓ ${empleadosDisponibles} empleado(s) disponible(s) para este servicio`;
                                        ayudaEmpleado.className = 'form-text text-success d-block mt-1';
                                    }
                                }
                                
                                // Limpiar selección si el empleado actual no está disponible
                                if (empleadoSelect.value) {
                                    const selectedOpt = empleadoSelect.options[empleadoSelect.selectedIndex];
                                    if (selectedOpt && selectedOpt.style.display === 'none') {
                                        empleadoSelect.value = '';
                                    }
                                }
                            }
                            
                            // Filtrar empleados cuando se carga la página si ya hay un servicio seleccionado
                            setTimeout(filtrarEmpleadosPorServicioCrear, 200);
                        });
                        </script>
                    </form>
                </div>
            </div>

            <div class="mt-4">
                <a href="{% url 'servicios_lista' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver a la lista
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
